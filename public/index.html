<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkShield - Advanced URL Shortener</title>
    
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    
    <style>
        /* TO√ÄN B·ªò CSS C·ª¶A B·∫†N GI·ªÆ NGUY√äN */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap');
        :root{--bg-primary:#0a0a0a;--bg-secondary:#111111;--bg-tertiary:#1a1a1a;--bg-card:#151515;--border:#333333;--border-hover:#444444;--text-primary:#ffffff;--text-secondary:#b3b3b3;--text-muted:#666666;--accent:#00d4aa;--accent-hover:#00b894;--warning:#fdcb6e;--error:#e74c3c;--success:#00b894;--purple:#a29bfe;--blue:#74b9ff;--orange:#fd79a8;--gradient-main:linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);--gradient-accent:linear-gradient(135deg, #00d4aa 0%, #00b894 100%);--shadow:0 8px 32px rgba(0, 0, 0, 0.3);--shadow-hover:0 12px 48px rgba(0, 0, 0, 0.4);}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Inter', sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}
        .container{max-width:1400px;margin:0 auto;padding:20px;position:relative;}
        .header{text-align:center;margin-bottom:50px;position:relative;}
        .header h1{font-family:'JetBrains Mono', monospace;font-size:3.5rem;font-weight:700;background:var(--gradient-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:15px;position:relative;}
        /* ... D√°n to√†n b·ªô ph·∫ßn <style> t·ª´ file g·ªëc c·ªßa b·∫°n v√†o ƒë√¢y ... */
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="floating-particles" id="particles"></div>
    
    <div class="container">
        <div class="header">
            <h1>‚ö° LinkShield</h1>
            <p>Advanced URL Protection & Analytics Platform</p>
        </div>

        <div id="main-page">
            <div class="main-content">
                <div class="card">
                    <h2>üöÄ Create Protected Link</h2>
                    <form id="create-form">
                        <div class="form-group">
                            <label for="link-title">Link Title (Optional):</label>
                            <input type="text" id="link-title" placeholder="e.g., My Secret Document">
                        </div>
                        <div class="form-group">
                            <label for="original-url">Original URL:</label>
                            <input type="url" id="original-url" placeholder="https://example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password Protection (Optional):</label>
                            <input type="password" id="password" placeholder="Enter password">
                        </div>
                        <div class="features-section">
                             <div class="features-title">üõ°Ô∏è Protection Features</div>
                            <div class="features-grid">
                                <div class="feature-option free" data-type="ip"><div class="feature-checkbox"></div><div class="feature-info"><div class="feature-name">‚úÖ IP Address Tracking<span class="feature-badge badge-free">Free</span></div><div class="feature-cost">Real-time visitor IP logging</div></div></div>
                                <div class="feature-option premium" data-type="cloudflare"><div class="feature-checkbox"></div><div class="feature-info"><div class="feature-name">üîí Cloudflare CAPTCHA<span class="feature-badge badge-premium">Free</span></div><div class="feature-cost">Advanced bot protection</div></div></div>
                                <div class="feature-option premium" data-type="geoblock"><div class="feature-checkbox"></div><div class="feature-info"><div class="feature-name">üè¥ GeoBlock (VN only ‚Äî 15 coin)<span class="feature-badge badge-premium">Free</span></div><div class="feature-cost">Vietnam-only access restriction</div></div></div>
                                <div class="feature-option premium" data-type="fingerprint"><div class="feature-checkbox"></div><div class="feature-info"><div class="feature-name">üîç Browser Fingerprint Collection<span class="feature-badge badge-premium">Free</span></div><div class="feature-cost">Advanced device tracking</div></div></div>
                            </div>
                        </div>
                        <button type="submit" class="btn">Generate Protected Link</button>
                    </form>
                    <div id="create-result" class="result"></div>
                </div>
                <div class="card">
                    <h2>üìä Link Management</h2>
                    <div id="my-links">
                        <div class="empty-state"><div class="empty-state-icon">üîó</div><p>No links created from this device yet</p></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="verification-page" class="verification-page">
             </div>
        <div id="password-page" class="password-page">
             </div>
    </div>

    <script>
        // TO√ÄN B·ªò LOGIC G·ªêC C·ª¶A B·∫†N S·∫º N·∫∞M ·ªû ƒê√ÇY
        // CH·ªà S·ª¨A 2 CH·ªñ QUAN TR·ªåNG

        let links = JSON.parse(localStorage.getItem('linkshield_links') || '[]');
        let currentVerification = null;
        let captchaToken = null;

        // --- THAY ƒê·ªîI 1: X·ª¨ L√ù FORM T·∫†O LINK ---
        document.getElementById('create-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const originalUrl = document.getElementById('original-url').value;
            const password = document.getElementById('password').value;
            const title = document.getElementById('link-title').value;
            const selectedFeatures = Array.from(document.querySelectorAll('.feature-option.selected'))
                                          .map(option => option.getAttribute('data-type'));
            
            if (selectedFeatures.length === 0) {
                showResult('create-result', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt t√≠nh nƒÉng b·∫£o v·ªá!', true);
                return;
            }

            const createButton = this.querySelector('.btn');
            createButton.disabled = true;
            createButton.textContent = 'ƒêang t·∫°o...';

            try {
                // G√≥i d·ªØ li·ªáu ƒë·ªÉ g·ª≠i l√™n server
                const payload = {
                    originalUrl,
                    password,
                    title,
                    features: selectedFeatures
                };

                // G·ªçi API c·ªßa backend
                const response = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'T·∫°o link th·∫•t b·∫°i.');
                }
                
                const data = await response.json();
                const shortUrl = data.shortUrl;

                showResult('create-result', `T·∫°o link ƒë∆∞·ª£c b·∫£o v·ªá th√†nh c√¥ng!`);

                // Hi·ªÉn th·ªã link trong code block
                setTimeout(() => {
                    const result = document.getElementById('create-result');
                    result.innerHTML += `
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                            <div class="code-block" style="flex-grow: 1; margin: 0;">${shortUrl}</div>
                            <button class="btn-small" onclick="copyToClipboard('${shortUrl}')">üìã Sao ch√©p</button>
                        </div>`;
                }, 1000);

                // L∆∞u m·ªôt b·∫£n sao v√†o localStorage ƒë·ªÉ qu·∫£n l√Ω
                const localLinkData = {
                    ...payload,
                    id: 'local_' + Date.now(), // ID ch·ªâ d√πng cho vi·ªác x√≥a local
                    shortUrl: shortUrl,
                    createdAt: new Date().toISOString()
                };
                links.push(localLinkData);
                saveData();
                updateMyLinks();
                this.reset();
                document.querySelectorAll('.feature-option').forEach(opt => opt.classList.remove('selected'));

            } catch (error) {
                showResult('create-result', error.message, true);
            } finally {
                createButton.disabled = false;
                createButton.textContent = 'Generate Protected Link';
            }
        });


        // --- THAY ƒê·ªîI 2: KI·ªÇM TRA LINK KHI T·∫¢I TRANG ---
        window.addEventListener('load', function() {
            createParticles();
            
            // KI·ªÇM TRA BI·∫æN M√Ä SERVER ƒê√É NH√öNG V√ÄO
            if (window.__LINK_DATA__) {
                const link = window.__LINK_DATA__;
                currentVerification = link; // ƒê√¢y l√† d·ªØ li·ªáu t·ª´ server

                if (link.password && link.password.length > 0) {
                    // N·∫øu link c√≥ m·∫≠t kh·∫©u, hi·ªÉn th·ªã trang nh·∫≠p m·∫≠t kh·∫©u
                    document.getElementById('main-page').style.display = 'none';
                    document.getElementById('password-page').style.display = 'block';
                } else {
                    // N·∫øu kh√¥ng, b·∫Øt ƒë·∫ßu quy tr√¨nh x√°c th·ª±c ngay
                    startVerification();
                }
            } else {
                // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu nh√∫ng, ƒë√¢y l√† trang ch·ªß ƒë·ªÉ t·∫°o link
                updateMyLinks();
            }
        });


        // --- C√ÅC H√ÄM C√íN L·∫†I GI·ªÆ NGUY√äN 100% NH∆Ø FILE G·ªêC C·ª¶A B·∫†N ---
        // (Bao g·ªìm createParticles, getAdvancedFingerprint, saveData, showResult,
        // updateMyLinks, toggleVisitorDetails, copyToClipboard, deleteLink,
        // onCaptchaSuccess, startVerification, c√°c h√†m show... v√† completeVerification)

        function createParticles() { /* ... code g·ªëc ... */ }
        function getAdvancedFingerprint() { /* ... code g·ªëc ... */ }
        function generateId() { return 'ls_' + Math.random().toString(36).substr(2, 12) + Date.now().toString(36); }
        function saveData() { localStorage.setItem('linkshield_links', JSON.stringify(links)); }
        function showResult(elementId, message, isError = false) { /* ... code g·ªëc, ƒë√£ c√≥ ·ªü tr√™n ... */ }
        function updateMyLinks() { /* ... code g·ªëc ... */ }
        function toggleVisitorDetails(linkId, button) { /* ... code g·ªëc ... */ }
        function copyToClipboard(text) { /* ... code g·ªëc ... */ }
        function deleteLink(id) {
             if (confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a link n√†y kh·ªèi danh s√°ch qu·∫£n l√Ω?\nLink r√∫t g·ªçn v·∫´n s·∫Ω ho·∫°t ƒë·ªông.')) {
                links = links.filter(link => link.id !== id);
                saveData();
                updateMyLinks();
            }
        }
        window.onCaptchaSuccess = function(token) { /* ... code g·ªëc ... */};
        function startVerification() { /* ... code g·ªëc ... */ }
        function showIPTracking(callback) { /* ... code g·ªëc ... */ }
        function showCloudflareCaptcha(callback) { /* ... code g·ªëc ... */ }
        function showGeoBlock(callback) { /* ... code g·ªëc ... */ }
        function showFingerprintCollection(callback) { /* ... code g·ªëc ... */ }
        function completeVerification() { /* ... code g·ªëc ... */ }
        document.getElementById('password-form').addEventListener('submit', function(e) { /* ... code g·ªëc ... */ });

        // D√°n t·∫•t c·∫£ c√°c h√†m JavaScript c√≤n thi·∫øu t·ª´ file g·ªëc c·ªßa b·∫°n v√†o ƒë√¢y
        
    </script>
</body>
</html>
